"""Decision attribution service.

This module handles the persistence of trading decisions generated by LLMs,
creating an audit trail that links decisions to source newsletters.
"""

from typing import Any
from supabase import Client

from core.models import DecisionObject
from core.config import logger


def save_decision(
    client: Client,
    decision: DecisionObject
) -> dict[str, Any]:
    """Save a trading decision to the database for attribution.

    Args:
        client: The Supabase client instance.
        decision: The DecisionObject containing the trading signal and metadata.

    Returns:
        The inserted row data as a dictionary.

    Raises:
        Exception: If the insert operation fails.
    """
    payload = {
        "source_id": decision.source_id,
        "ticker": decision.ticker,
        "signal": decision.signal,
        "confidence": decision.confidence,
        "reasoning": decision.reasoning,
        "model_provider": decision.model_provider,
        "model_name": decision.model_name,
    }

    try:
        response = client.table("decisions").insert(payload).execute()
        
        if not response.data:
            logger.warning(f"Decision for {decision.ticker} saved but no data returned.")
            return {}
            
        return response.data[0]
    except Exception as e:
        logger.error(f"Failed to save decision for {decision.ticker}: {e}")
        raise
